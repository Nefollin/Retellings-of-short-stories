<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Novel Summarizer ‚Äî Preview (API-ready)</title>
<style>
  :root{
    --bg:#0f1115;--panel:#171a21;--panel-2:#1e232d;--text:#e6e7ea;--muted:#9aa3b2;--acc:#2dd4bf;--acc-2:#60a5fa;--danger:#f43f5e;--ok:#22c55e;--border:#2a3140;
    --radius:16px;--radius-sm:12px;--shadow:0 8px 24px rgba(0,0,0,.35),0 1px 0 rgba(255,255,255,.02) inset;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0e1014,#0c0f14);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"}
  a{color:var(--acc-2);text-decoration:none}
  .app{max-width:980px;margin:0 auto;padding-bottom:96px}
  header{position:sticky;top:0;z-index:10;background:rgba(15,17,21,.8);backdrop-filter:saturate(140%) blur(12px);border-bottom:1px solid var(--border)}
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--acc),var(--acc-2));box-shadow:0 4px 12px rgba(45,212,191,.35)}
  .title{font-weight:700;letter-spacing:.2px}
  .tabs{display:flex;gap:6px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--panel);color:var(--text);cursor:pointer}
  .tab[aria-selected="true"]{background:var(--acc-2);border-color:transparent;color:#071019}

  main{padding:18px 16px 24px}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .card+.card{margin-top:14px}
  .section{margin:14px 0}
  .section h3{margin:0 0 10px;font-size:16px;font-weight:700}

  .row{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1 1 320px}

  .form{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px}
  .form input[type="url"], .form select, .form input[type="text"]{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--border);background:var(--panel-2);color:var(--text)}
  .btn{padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:var(--panel-2);color:var(--text);cursor:pointer}
  .btn.acc{background:linear-gradient(135deg,var(--acc),var(--acc-2));border-color:transparent;color:#061017;font-weight:700}
  .btn.ghost{background:transparent}
  .btn.small{padding:8px 10px;border-radius:10px}

  .list{display:flex;flex-direction:column;gap:10px}
  .item{display:flex;gap:12px;padding:12px;border:1px solid var(--border);border-radius:14px;background:var(--panel-2)}
  .item .cover{width:64px;height:64px;border-radius:10px;flex:0 0 auto;background:#0a0d12 center/cover no-repeat}
  .meta{flex:1 1 auto;min-width:0}
  .titleline{display:flex;gap:8px;align-items:center}
  .name{font-weight:700}
  .src{color:var(--muted);font-size:12px}
  .desc{margin-top:4px;color:var(--muted);overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
  .actions{display:flex;gap:8px;align-items:center}

  .chip{font-size:12px;color:#091018;background:linear-gradient(135deg,var(--acc),var(--acc-2));padding:3px 8px;border-radius:8px}
  .iconbtn{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:var(--panel);display:grid;place-items:center;cursor:pointer}

  /* Novel detail */
  .novel-head{display:flex;gap:16px;padding:14px}
  .novel-cover{width:96px;height:128px;border-radius:14px;background:#0a0d12 center/cover no-repeat;border:1px solid var(--border)}
  .novel-info{flex:1}
  .novel-info h2{margin:0 0 6px}
  .muted{color:var(--muted)}
  .list.summaries .item{align-items:center}
  .grow{flex:1}

  .empty{padding:36px;text-align:center;color:var(--muted)}

  footer.nav{position:fixed;left:0;right:0;bottom:0;background:rgba(15,17,21,.9);backdrop-filter:blur(12px);border-top:1px solid var(--border)}
  .navwrap{max-width:980px;margin:0 auto;display:grid;grid-template-columns:repeat(3,1fr)}
  .navbtn{padding:12px;text-align:center;cursor:pointer;color:var(--muted)}
  .navbtn[aria-current="page"]{color:#fff}

  /* tiny icons */
  .i{font-style:normal;display:inline-block;vertical-align:middle}
  .i::before{content:attr(data-i)}

  .hint{margin:10px 2px 0;color:var(--muted)}
  .danger{color:var(--danger)}
</style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="brand"><div class="logo"></div><div class="title">Novel Summarizer</div></div>
      <div class="tabs">
        <button class="tab" data-tab="home" aria-selected="true">–ì–ª–∞–≤–Ω–∞—è</button>
        <button class="tab" data-tab="bookmarks">–ó–∞–∫–ª–∞–¥–∫–∏</button>
        <button class="tab" data-tab="menu">–ú–µ–Ω—é</button>
      </div>
    </div>
  </header>

  <div class="app">
    <main id="view-home">
      <div class="card section">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–µ–ª–ª—É</h3>
        <div class="form">
          <input id="url" type="url" placeholder="https://example.com/novel/..." />
          <select id="lang"><option>RU</option><option>EN</option><option>DE</option></select>
          <select id="depth"><option value="short">–ö—Ä–∞—Ç–∫–æ</option><option value="mid">–°—Ä–µ–¥–Ω–µ</option><option value="full">–ü–æ–¥—Ä–æ–±–Ω–æ</option></select>
          <button class="btn acc" id="start">–ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
        </div>
        <p class="hint" id="mode-hint"></p>
      </div>

      <div class="section">
        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–µ–ª–ª—ã</h3>
        <div class="list" id="novels-list"></div>
      </div>
    </main>

    <main id="view-bookmarks" hidden>
      <div class="section"><h3>–ó–∞–∫–ª–∞–¥–∫–∏</h3></div>
      <div class="list" id="bm-list"></div>
    </main>

    <main id="view-menu" hidden>
      <div class="card" style="padding:16px">
        <h3>–ê–∫–∫–∞—É–Ω—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div class="row">
          <div class="col">
            <div class="item">
              <div class="grow">
                <div class="name">API URL</div>
                <div class="muted">–£–∫–∞–∂–∏ –∞–¥—Ä–µ—Å backend, –Ω–∞–ø—Ä–∏–º–µ—Ä: https://your-app.onrender.com</div>
                <div style="margin-top:8px;display:flex;gap:8px">
                  <input id="api-base" type="text" placeholder="(–ø—É—Å—Ç–æ = –æ—Ñ–ª–∞–π–Ω –¥–µ–º–æ)" style="flex:1" />
                  <button class="btn small" id="save-api">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  <button class="btn small ghost" id="clear-api">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
              </div>
            </div>
            <div class="item">
              <div class="grow">
                <div class="name">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</div>
                <div class="muted">–ò–º–∏—Ç–∞—Ü–∏—è –¥–µ–π—Å—Ç–≤–∏—è –≤ –ø—Ä–æ—Ç–æ—Ç–∏–ø–µ</div>
              </div>
              <button class="btn small" onclick="alert('–î–µ–º–æ: –∞–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω (—Å–∏–º—É–ª—è—Ü–∏—è)')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Novel detail -->
    <main id="view-novel" hidden>
      <div class="card">
        <div class="novel-head">
          <div class="novel-cover" id="novel-cover"></div>
          <div class="novel-info">
            <h2 id="novel-title">–ù–∞–∑–≤–∞–Ω–∏–µ</h2>
            <div class="muted">–ò—Å—Ç–æ—á–Ω–∏–∫: <a id="novel-src" href="#" target="_blank" rel="noopener">link</a></div>
            <div id="novel-api" class="muted" style="margin-top:4px"></div>
            <div style="margin-top:10px;display:flex;gap:8px">
              <button class="btn small" id="btn-dl-all">–°–∫–∞—á–∞—Ç—å –≤—Å—ë</button>
              <button class="btn small" id="btn-bm"><span class="i" data-i="‚≠ê"></span>&nbsp;–í –∑–∞–∫–ª–∞–¥–∫–∏</button>
              <button class="btn small ghost" onclick="go('home')">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
          </div>
        </div>
        <div class="section" style="padding:0 14px 14px">
          <h3>–ü–µ—Ä–µ—Å–∫–∞–∑—ã –≥–ª–∞–≤</h3>
          <div class="list summaries" id="summaries"></div>
        </div>
      </div>
    </main>
  </div>

  <footer class="nav">
    <div class="navwrap">
      <div class="navbtn" data-tab="home" aria-current="page">üè† –ì–ª–∞–≤–Ω–∞—è</div>
      <div class="navbtn" data-tab="bookmarks">üîñ –ó–∞–∫–ª–∞–¥–∫–∏</div>
      <div class="navbtn" data-tab="menu">‚ò∞ –ú–µ–Ω—é</div>
    </div>
  </footer>

<script>
/*************** MODE & SETTINGS ***************/
const API_BASE = localStorage.getItem('api_base') || '';
const modeHint = document.getElementById('mode-hint');
modeHint.innerHTML = !API_BASE
  ? '–†–µ–∂–∏–º: <b>–æ—Ñ–ª–∞–π–Ω –¥–µ–º–æ</b> ‚Äî –±–µ–∑ —Å–µ—Ç–∏. –û–±–ª–æ–∂–∫–∏ —Ä–∏—Å—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ, –ø–µ—Ä–µ—Å–∫–∞–∑—ã ‚Äî –º–æ–∫.'
  : `–†–µ–∂–∏–º: <b>–æ–Ω–ª–∞–π–Ω</b>. Backend: <code>${API_BASE}</code>. –ë—É–¥—É—Ç —Å–µ—Ç–∏ –∏ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Å–∫–∞–∑—ã.`;

// Settings UI
const apiInput = document.getElementById('api-base');
apiInput.value = API_BASE;
document.getElementById('save-api').onclick = () => {
  localStorage.setItem('api_base', apiInput.value.trim());
  location.reload();
};
document.getElementById('clear-api').onclick = () => {
  localStorage.removeItem('api_base');
  location.reload();
};

/*************** OFFLINE COVER (NO NETWORK) ***************/
function coverDataURL(seedText){
  const w=300,h=420; const title=(seedText||'Novel').slice(0,28).replace(/&/g,'&amp;');
  const svg=`<svg xmlns='http://www.w3.org/2000/svg' width='${w}' height='${h}'>
    <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
      <stop offset='0' stop-color='#14b8a6'/><stop offset='1' stop-color='#60a5fa'/>
    </linearGradient></defs>
    <rect width='100%' height='100%' fill='url(#g)'/>
    <rect x='10' y='10' width='${w-20}' height='${h-20}' rx='18' fill='rgba(0,0,0,0.35)'/>
    <text x='50%' y='50%' text-anchor='middle' fill='white' font-size='24' font-family='system-ui,Segoe UI,Roboto' dy='.35em'>${title}</text>
  </svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

/*************** STATE ***************/
const state = {
  novels: !API_BASE ? [
    { id: crypto.randomUUID(), title: '–í—Å–µ –≥—Ä—è–¥—É—â–∏–µ –¥–Ω–∏', src: 'https://example.com/all-tomorrows', cover: coverDataURL('–í—Å–µ –≥—Ä—è–¥—É—â–∏–µ –¥–Ω–∏'), depth: 'short', lang: 'RU', summaries: Array.from({length:6}).map((_,i)=>({ n:i+1, text:`[–î–µ–º–æ] –ü–µ—Ä–µ—Å–∫–∞–∑ –≥–ª–∞–≤—ã ${i+1}‚Ä¶` })) },
    { id: crypto.randomUUID(), title: '–ü—Å–∏—Ö', src: 'https://author-novels.com/psycho', cover: coverDataURL('–ü—Å–∏—Ö'), depth: 'mid', lang: 'RU', summaries: Array.from({length:5}).map((_,i)=>({ n:i+1, text:`[–î–µ–º–æ] –°–∂–∞—Ç–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ ${i+1}‚Ä¶` })) }
  ] : [],
  bookmarks: JSON.parse(localStorage.getItem('ns_bm')||'[]'),
  currentNovelApiId: null,
};

/*************** ROUTING ***************/
const views = {
  home: document.getElementById('view-home'),
  bookmarks: document.getElementById('view-bookmarks'),
  menu: document.getElementById('view-menu'),
  novel: document.getElementById('view-novel'),
};
function go(tab){
  for(const k in views){views[k].hidden = true}
  const target = tab==='novel'? 'novel' : tab; views[target].hidden = false;
  document.querySelectorAll('.tab').forEach(b=>b.setAttribute('aria-selected', String(b.dataset.tab===tab)));
  document.querySelectorAll('.navbtn').forEach(b=>b.setAttribute('aria-current', b.dataset.tab===tab? 'page':'false'));
  if(tab==='home') renderHome();
  if(tab==='bookmarks') renderBookmarks();
}
Array.from(document.querySelectorAll('.navbtn')).forEach(b=>b.onclick=()=>go(b.dataset.tab));
Array.from(document.querySelectorAll('.tab')).forEach(b=>b.onclick=()=>go(b.dataset.tab));

/*************** RENDER HOME ***************/
const list = document.getElementById('novels-list');
function renderHome(){
  list.innerHTML='';
  state.novels.forEach(n=>list.appendChild(novelItem(n)));
}
function novelItem(n){
  const el = document.createElement('div'); el.className='item';
  el.innerHTML = `
    <div class="cover" style="background-image:url('${n.cover || coverDataURL(n.title)}')"></div>
    <div class="meta">
      <div class="titleline"><div class="name">${n.title}</div><span class="chip">${n.lang || 'RU'} ¬∑ ${depthLabel(n.depth||'short')}</span></div>
      <div class="src">${n.src || ''}</div>
      <div class="desc">${n.summaries?.[0]?.text || '–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å–∫–∞–∑–∞'}</div>
    </div>
    <div class="actions">
      <button class="iconbtn" title="–°–∫–∞—á–∞—Ç—å –≤—Å—ë" data-act="dl">‚¨áÔ∏è</button>
      <button class="iconbtn" title="–í –∑–∞–∫–ª–∞–¥–∫–∏" data-act="bm">üîñ</button>
      <button class="iconbtn" title="–û—Ç–∫—Ä—ã—Ç—å" data-act="open">üìñ</button>
    </div>`;
  el.querySelector('[data-act="dl"]').onclick=()=>downloadNovel(n);
  el.querySelector('[data-act="bm"]').onclick=()=>toggleBM(n.id);
  el.querySelector('[data-act="open"]').onclick=()=>openNovel(n.id);
  return el;
}
function depthLabel(d){return d==='short'? '–ö—Ä–∞—Ç–∫–æ': d==='mid'? '–°—Ä–µ–¥–Ω–µ':'–ü–æ–¥—Ä–æ–±–Ω–æ'}

/*************** BOOKMARKS ***************/
const bmList = document.getElementById('bm-list');
function renderBookmarks(){
  bmList.innerHTML='';
  const ids = new Set(state.bookmarks);
  const arr = state.novels.filter(n=>ids.has(n.id));
  if(!arr.length){ bmList.innerHTML = `<div class=\"empty\">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤–ª—è–π—Ç–µ –Ω–æ–≤–µ–ª–ª—ã —Å –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</div>`; return; }
  arr.forEach(n=>bmList.appendChild(novelItem(n)));
}
function toggleBM(id){
  const idx = state.bookmarks.indexOf(id);
  if(idx>-1) state.bookmarks.splice(idx,1); else state.bookmarks.push(id);
  localStorage.setItem('ns_bm', JSON.stringify(state.bookmarks));
  renderBookmarks();
}

/*************** NOVEL DETAIL ***************/
let currentNovel = null;
function openNovel(id){
  currentNovel = state.novels.find(n=>n.id===id);
  if(!currentNovel) return;
  document.getElementById('novel-cover').style.backgroundImage = `url('${currentNovel.cover || coverDataURL(currentNovel.title)}')`;
  document.getElementById('novel-title').textContent = currentNovel.title;
  const a = document.getElementById('novel-src'); a.href = currentNovel.src || '#'; a.textContent = currentNovel.src || '';
  document.getElementById('novel-api').textContent = API_BASE ? `API: ${API_BASE}` : 'API: –æ—Ñ–ª–∞–π–Ω-–¥–µ–º–æ';
  const cont = document.getElementById('summaries'); cont.innerHTML='';

  // offline: render demo summaries
  if(!API_BASE){
    currentNovel.summaries.forEach(s=>cont.appendChild(chapterRowDemo(s)));
  } else {
    // online: list chapters status from API
    if(currentNovel.apiId){
      loadChaptersFromApi(currentNovel.apiId);
    } else {
      // until chapters loaded, show hint
      const row = document.createElement('div'); row.className='item'; row.innerHTML = `<div class='muted'>–ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫ –≥–ª–∞–≤‚Ä¶</div>`; cont.appendChild(row);
    }
  }

  document.getElementById('btn-bm').onclick=()=>toggleBM(currentNovel.id);
  document.getElementById('btn-dl-all').onclick=()=>API_BASE && currentNovel.apiId ? (location.href = `${API_BASE}/api/novels/${currentNovel.apiId}/download.txt`) : downloadNovel(currentNovel);
  go('novel');
}

function chapterRowDemo(s){
  const row = document.createElement('div'); row.className='item';
  row.innerHTML = `<div class='muted'>–¢–æ–º 1 ¬∑ –ì–ª–∞–≤–∞ ${s.n}</div><div class='grow'></div><button class='btn small' data-n='${s.n}'>–°–∫–∞—á–∞—Ç—å</button>`;
  row.querySelector('button').onclick=()=>downloadChapter(currentNovel, s.n);
  return row;
}

function renderApiChapters(list){
  const cont = document.getElementById('summaries'); cont.innerHTML='';
  list.forEach(ch => {
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `
      <div class='muted'>–¢–æ–º 1 ¬∑ –ì–ª–∞–≤–∞ ${ch.n}</div>
      <div class='grow'></div>
      ${ch.hasSummary ? '<span class="chip">–≥–æ—Ç–æ–≤–æ</span>' : ''}
      <button class='btn small' data-n='${ch.n}'>${ch.hasSummary ? '–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å' : '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å'}</button>
    `;
    row.querySelector('button').onclick = async () => {
      row.querySelector('button').disabled = true; row.querySelector('button').textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è‚Ä¶';
      try{
        await fetch(`${API_BASE}/api/novels/${currentNovel.apiId}/chapters/${ch.n}/summary`, { method:'POST' });
        await loadChaptersFromApi(currentNovel.apiId);
      }catch(e){ alert('–û—à–∏–±–∫–∞: '+e.message); }
    };
    cont.appendChild(row);
  });
}

/*************** DOWNLOAD (OFFLINE) ***************/
function downloadChapter(novel, n){
  const s = novel.summaries.find(x=>x.n===n);
  const text = `# ${novel.title}\n–ò—Å—Ç–æ—á–Ω–∏–∫: ${novel.src}\n–Ø–∑—ã–∫: ${novel.lang}\n–ì–ª—É–±–∏–Ω–∞: ${depthLabel(novel.depth)}\n\n–ì–ª–∞–≤–∞ ${n}\n\n${s.text}\n`;
  saveFile(text, `${slug(novel.title)}_chapter_${n}.txt`);
}
function downloadNovel(novel){
  const text = `# ${novel.title}\n–ò—Å—Ç–æ—á–Ω–∏–∫: ${novel.src}\n–Ø–∑—ã–∫: ${novel.lang}\n–ì–ª—É–±–∏–Ω–∞: ${depthLabel(novel.depth)}\n\n` + (novel.summaries||[]).map(s=>`–ì–ª–∞–≤–∞ ${s.n}\n${s.text}\n`).join("\n");
  saveFile(text, `${slug(novel.title)}_summaries.txt`);
}
function saveFile(text, name){
  const blob = new Blob([text],{type:'text/plain;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
const slug = s=>s.toLowerCase().replace(/[^a-z–∞-—è0-9]+/gi,'-').replace(/^-+|-+$/g,'');

/*************** ADD NOVEL ***************/
const urlEl = document.getElementById('url');
const langEl = document.getElementById('lang');
const depthEl = document.getElementById('depth');
const startBtn = document.getElementById('start');
startBtn.onclick = async ()=>{
  const u = urlEl.value.trim(); if(!u){ alert('–í—Å—Ç–∞–≤—å—Ç–µ URL –Ω–æ–≤–µ–ª–ª—ã'); return; }
  if(!API_BASE){ // offline demo
    const title = guessTitleFromURL(u);
    const novel = { id: crypto.randomUUID(), title, src: u, cover: coverDataURL(title), depth: depthEl.value, lang: langEl.value, summaries: Array.from({length:6}).map((_,i)=>({n:i+1,text:`[–î–µ–º–æ] –ü–µ—Ä–µ—Å–∫–∞–∑ –≥–ª–∞–≤—ã ${i+1} –¥–ª—è ¬´${title}¬ª. –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–µ–∫—Å—Ç, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API.`})) };
    state.novels.unshift(novel); urlEl.value=''; renderHome(); openNovel(novel.id);
  } else { // online
    try{
      startBtn.disabled = true; startBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞‚Ä¶';
      const r = await fetch(`${API_BASE}/api/process`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ url: u, lang: langEl.value, depth: depthEl.value, style:'neutral' }) });
      const data = await r.json(); if(!r.ok) throw new Error(data.error || 'API error');
      // add shell novel item
      const title = guessTitleFromURL(u);
      const novel = { id: crypto.randomUUID(), title, src: u, cover: coverDataURL(title), depth: depthEl.value, lang: langEl.value, summaries: [] };
      novel.apiId = data.id; state.novels.unshift(novel); state.currentNovelApiId = data.id; urlEl.value=''; renderHome(); openNovel(novel.id);
      await loadChaptersFromApi(data.id);
    }catch(e){ alert('–û—à–∏–±–∫–∞: ' + e.message); }
    finally{ startBtn.disabled=false; startBtn.textContent='–ù–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É'; }
  }
}
function guessTitleFromURL(u){
  try{const p=new URL(u);return decodeURIComponent((p.pathname.split('/').filter(Boolean).pop()||p.hostname)).replace(/[-_]+/g,' ').replace(/\b\w/g,m=>m.toUpperCase())}catch{return u}
}

async function loadChaptersFromApi(apiId){
  try{
    const r = await fetch(`${API_BASE}/api/novels/${apiId}`);
    const d = await r.json(); if(!r.ok) throw new Error(d.error || 'API error');
    if(currentNovel){ currentNovel.apiId=apiId; currentNovel.title = d.title || currentNovel.title; }
    renderApiChapters(d.chapters || []);
  }catch(e){ alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤: '+e.message); }
}

/*************** INIT ***************/
renderHome();
</script>

<!--
Backend reference (server.js): —Å–º. –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ —á–∞—Ç–µ. 
API –æ–∂–∏–¥–∞–µ—Ç—Å—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–µ:
  POST   /api/process {url,lang,depth,style} -> {id, chapters:[{n,url}]}
  GET    /api/novels/:id -> {title, chapters:[{n,hasSummary}]}
  POST   /api/novels/:id/chapters/:n/summary -> {n, summary}
  GET    /api/novels/:id/download.txt -> text
-->
</body>
</html>
